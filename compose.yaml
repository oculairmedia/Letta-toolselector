services:
  weaviate:
    image: semitechnologies/weaviate:1.25.0
    ports:
      - 8080:8080
      - 50051:50051
    environment:
      QUERY_DEFAULTS_LIMIT: 15
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      DEFAULT_VECTORIZER_MODULE: text2vec-ollama
      ENABLE_MODULES: text2vec-ollama,text2vec-openai,reranker-transformers
      CLUSTER_HOSTNAME: node1
      READINESS_MAX_WAIT_SECS: 300
      # Ollama configuration for text2vec-ollama module
      OLLAMA_API_ENDPOINT: http://192.168.50.80:11434
      TEXT2VEC_OLLAMA_API_ENDPOINT: http://192.168.50.80:11434
      # Point to our Ollama reranker adapter
      RERANKER_INFERENCE_API: http://reranker:8080
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test:
        - CMD
        - sh
        - -c
        - nc -z localhost 8080 || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    depends_on:
      reranker:
        condition: service_healthy
    networks:
      - letta-tools

  reranker:
    image: ghcr.io/oculairmedia/letta-toolselector-reranker:main
    container_name: letta-toolselector-reranker
    ports:
      - 8091:8080
    environment:
      - OLLAMA_BASE_URL=http://192.168.50.80:11434
      - OLLAMA_MODEL=dengcao/Qwen3-Reranker-4B:Q5_K_M
      - BATCH_SIZE=10
      - TIMEOUT_SECONDS=30
      - LOG_LEVEL=INFO
      - ENABLE_CACHE=true
      - CACHE_TTL=300
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8080/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - letta-tools

  tool-selector-api:
    image: ghcr.io/oculairmedia/letta-toolselector-tool-selector-api:main
    container_name: letta-toolselector-api
    ports:
      - 8020:3001
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LETTA_API_URL=${LETTA_API_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - WEAVIATE_URL=http://weaviate:8080/
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY}
      - PORT=3001
      - DEFAULT_DROP_RATE=${DEFAULT_DROP_RATE:-0.6}
      - MAX_TOTAL_TOOLS=${MAX_TOTAL_TOOLS:-20}
      - MAX_MCP_TOOLS=${MAX_MCP_TOOLS:-15}
      - MIN_MCP_TOOLS=${MIN_MCP_TOOLS:-7}
      - EXCLUDE_LETTA_CORE_TOOLS=${EXCLUDE_LETTA_CORE_TOOLS:-true}
      - EXCLUDE_OFFICIAL_TOOLS=${EXCLUDE_OFFICIAL_TOOLS:-true}
      - MANAGE_ONLY_MCP_TOOLS=${MANAGE_ONLY_MCP_TOOLS:-true}
      - NEVER_DETACH_TOOLS=${NEVER_DETACH_TOOLS:-find_tools,Read,Write,Edit,Glob,Grep,Bash,BashOutput,KillBash,TodoWrite,Skill,AskUserQuestion,memory,memory_apply_patch,conversation_search,archival_memory_search,archival_memory_insert,find_agents,matrix_messaging,matrix_agent_message}
      - PROTECTED_TOOLS=${PROTECTED_TOOLS:-find_tools,Read,Write,Edit,Glob,Grep,Bash,BashOutput,KillBash,TodoWrite,Skill,AskUserQuestion,memory,memory_apply_patch,conversation_search,archival_memory_search,archival_memory_insert,find_agents,matrix_messaging,matrix_agent_message}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-ollama}
      - OLLAMA_EMBEDDING_HOST=${OLLAMA_EMBEDDING_HOST:-192.168.50.80}
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-dengcao/Qwen3-Embedding-4B:Q4_K_M}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-2560}
      - USE_OLLAMA_EMBEDDINGS=${USE_OLLAMA_EMBEDDINGS:-true}
      - ENABLE_RERANKING=${ENABLE_RERANKING:-false}
      - ENABLE_RERANKING_BY_DEFAULT=${ENABLE_RERANKING_BY_DEFAULT:-false}
      - RERANK_INITIAL_LIMIT=${RERANK_INITIAL_LIMIT:-50}
      - RERANK_TOP_K=${RERANK_TOP_K:-10}
      - RERANKER_MODEL=${RERANKER_MODEL:-qwen3-reranker-4b}
      - RERANKER_PROVIDER=${RERANKER_PROVIDER:-vllm}
      - RERANKER_URL=${RERANKER_URL:-http://100.81.139.20:11435/v1/rerank}
      - RERANKER_TIMEOUT=${RERANKER_TIMEOUT:-30.0}
      - RERANKER_TEMPERATURE=${RERANKER_TEMPERATURE:-0.1}
      - OLLAMA_RERANKER_BASE_URL=${OLLAMA_RERANKER_BASE_URL:-http://reranker:8080}
      - LETTA_DIRECT_MESSAGE_URL=${LETTA_DIRECT_MESSAGE_URL:-http://192.168.50.90:8283}
      - MATRIX_BRIDGE_WEBHOOK_URL=${MATRIX_BRIDGE_WEBHOOK_URL:-}
    restart: unless-stopped
    volumes:
      - ./.env:/app/.env:ro
      - tool_cache_volume:/app/runtime_cache
      - ./tool-selector-api:/app:rw
    depends_on:
      weaviate:
        condition: service_healthy
    networks:
      - letta-tools

  tool-sync:
    image: ghcr.io/oculairmedia/letta-toolselector-tool-sync:main
    container_name: letta-toolselector-sync
    command: python sync_service.py
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LETTA_API_URL=${LETTA_API_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - API_URL=http://tool-selector-api:3001
      - SYNC_INTERVAL=300
      - ENABLE_AUTO_ENRICHMENT=${ENABLE_AUTO_ENRICHMENT:-false}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-http://192.168.50.90:8082/v1}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-dummy}
      - ENRICHMENT_CACHE_DIR=/app/enrichment_cache
    volumes:
      - ./.env:/app/.env:ro
      - tool_cache_volume:/app/runtime_cache
      - enrichment_cache_volume:/app/enrichment_cache
      - ./tool-selector-api:/app:rw
    restart: unless-stopped
    depends_on:
      tool-selector-api:
        condition: service_started
    networks:
      - letta-tools

  semantic-enrichment:
    image: ghcr.io/oculairmedia/letta-toolselector-tool-sync:main
    container_name: letta-toolselector-enrichment
    command: python enrichment_service.py
    profiles:
      - enrichment
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-http://192.168.50.90:8082/v1}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-dummy}
      - ENRICHMENT_CACHE_DIR=/app/enrichment_cache
      - ENRICHMENT_INTERVAL=${ENRICHMENT_INTERVAL:-3600}
      - WEAVIATE_HTTP_HOST=weaviate
      - WEAVIATE_HTTP_PORT=8080
      - WEAVIATE_GRPC_PORT=50051
    volumes:
      - ./.env:/app/.env:ro
      - tool_cache_volume:/app/runtime_cache
      - enrichment_cache_volume:/app/enrichment_cache
      - ./tool-selector-api:/app:rw
    restart: unless-stopped
    depends_on:
      weaviate:
        condition: service_healthy
    networks:
      - letta-tools

  task-worker:
    build:
      context: .
      dockerfile: worker-service/Dockerfile
    container_name: letta-toolselector-worker
    ports:
      - 3021:3021
    environment:
      - WORKER_SERVICE_PORT=3021
      - WORKER_LOG_LEVEL=${WORKER_LOG_LEVEL:-INFO}
      - WORKER_SESSION_POOL_CONNECTIONS=${WORKER_SESSION_POOL_CONNECTIONS:-10}
      - WORKER_SESSION_POOL_MAXSIZE=${WORKER_SESSION_POOL_MAXSIZE:-25}
      - WORKER_SESSION_MAX_RETRIES=${WORKER_SESSION_MAX_RETRIES:-3}
      - TOOLS_API_BASE_URL=${TOOLS_API_BASE_URL}
      - TOOLS_API_ALLOW_INSECURE_HTTP=${TOOLS_API_ALLOW_INSECURE_HTTP:-false}
      - TOOL_SELECTOR_PASSWORD=${TOOL_SELECTOR_PASSWORD}
      - TOOL_SELECTOR_BEARER_TOKEN=${TOOL_SELECTOR_BEARER_TOKEN}
      - TOOLS_API_TIMEOUT=${TOOLS_API_TIMEOUT:-15}
      - FIND_TOOLS_MAX_LIMIT=${FIND_TOOLS_MAX_LIMIT:-25}
      - LETTA_API_URL=${LETTA_API_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:3021/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      tool-selector-api:
        condition: service_started
    networks:
      - letta-tools
    restart: unless-stopped

  time-service:
    image: ghcr.io/oculairmedia/letta-toolselector-tool-selector-api:main
    container_name: letta-toolselector-time
    command: python time_memory_service.py
    environment:
      - WEAVIATE_URL=http://weaviate:8080/
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LETTA_API_URL=http://192.168.50.90:8283/v1
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - UPDATE_INTERVAL=60
    volumes:
      - ./.env:/app/.env:ro
      - ./tool-selector-api/time_memory_service.py:/app/time_memory_service.py:ro
    restart: unless-stopped
    depends_on:
      weaviate:
        condition: service_healthy
    networks:
      - letta-tools

  tool-selector-mcp:
    image: ghcr.io/oculairmedia/letta-toolselector-tool-selector-mcp:main
    container_name: letta-toolselector-mcp
    ports:
      - 3020:3020
    environment:
      - PORT=3020
      - NODE_ENV=production
      - LETTA_API_URL=${LETTA_API_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - API_URL=http://tool-selector-api:3001
      - TOOLS_API_BASE_URL=http://tool-selector-api:3001
      - TOOLS_API_ALLOW_INSECURE_HTTP=true
      - WORKER_SERVICE_URL=http://task-worker:3021
      - WORKER_REQUEST_TIMEOUT_MS=${WORKER_REQUEST_TIMEOUT_MS:-15000}
    restart: unless-stopped
    labels:
      - homepage.group=MCP Services
      - homepage.name=Letta Toolselector MCP
      - homepage.icon=
      - homepage.href=http://192.168.50.90:3020/mcp
      - homepage.description=mcp server for the letta toolselector
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:3020/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - letta-tools

  dashboard-api:
    image: ghcr.io/oculairmedia/letta-toolselector-dashboard-api:main
    container_name: letta-toolselector-dashboard-api
    ports:
      - 8030:8030
    environment:
      - LDTS_API_URL=http://192.168.50.90:8020
      - LDTS_MCP_URL=http://tool-selector-mcp:3020/mcp
      - WEAVIATE_URL=http://weaviate:8080
      - LETTA_API_URL=${LETTA_API_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped
    labels:
      - homepage.group=LDTS Services
      - homepage.name=Dashboard Backend
      - homepage.icon=api
      - homepage.href=http://192.168.50.90:8030/api/v1/docs
      - homepage.description=LDTS Dashboard Backend API
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8030/api/v1/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      tool-selector-api:
        condition: service_started
      task-worker:
        condition: service_healthy
      tool-selector-mcp:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    networks:
      - letta-tools

  dashboard-ui:
    image: ghcr.io/oculairmedia/letta-toolselector-dashboard-ui:main
    container_name: letta-toolselector-dashboard-ui
    ports:
      - 8406:80
    environment:
      - REACT_APP_API_BASE_URL=/api/v1
      - REACT_APP_VERSION=${VERSION:-latest}
      - REACT_APP_BUILD_DATE=${BUILD_DATE}
      - REACT_APP_COMMIT_SHA=${COMMIT_SHA}
    restart: unless-stopped
    labels:
      - homepage.group=LDTS Services
      - homepage.name=LDTS Dashboard
      - homepage.icon=dashboard
      - homepage.href=http://192.168.50.90:8406
      - homepage.description=Letta Dynamic Tool Selection Dashboard
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      dashboard-api:
        condition: service_healthy
    networks:
      - letta-tools

networks:
  letta-tools:
    driver: bridge

volumes:
  weaviate_data: null
  tool_cache_volume: null
  enrichment_cache_volume: null
